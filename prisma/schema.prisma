// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// AUTHENTICATION & AUTHORIZATION
// ============================================================================

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  emailVerified DateTime?
  password      String // Hashed
  name          String
  image         String?

  // Employee fields (merged from Person)
  firstName      String?
  lastName       String?
  phone          String?
  mobile         String?
  dateOfBirth    DateTime?
  street         String?
  city           String?
  postalCode     String?
  country        String?
  companyId      Int?
  company        Company?  @relation("CompanyEmployees", fields: [companyId], references: [id], onDelete: SetNull)
  hireDate       DateTime?
  employmentType String? // "full-time", "part-time", "contractor"
  department     String?
  jobTitle       String?
  employeeStatus String? // "active", "on_leave", "terminated"
  salary         Decimal?  @db.Decimal(10, 2)
  salary_tax     Decimal?  @db.Decimal(10, 2)
  salary_bonus   Decimal?  @db.Decimal(10, 2)
  emergencyContact String?
  notes          String?

  // Relations
  accounts   Account[]
  sessions   Session[]
  userGroups UserGroupUser[]

  // Audit trail
  auditLogs       AuditLog[]
  createdIncome   Income[]     @relation("CreatedBy")
  createdExpenses Expense[]    @relation("CreatedBy")
  createdPayments Payment[]    @relation("CreatedBy")
  createdClients  Client[]     @relation("CreatedBy")
  createdProjects Project[]    @relation("CreatedBy")
  createdOffers   Offer[]      @relation("CreatedBy")
  createdTasks    Task[]       @relation("TaskCreatedBy")
  createdTimeRecords TimeRecord[] @relation("TimeRecordCreatedBy")

  // Notes authored by this user
  authoredNotes Note[]

  // Kanban board preferences
  boardPreferences UserBoardPreference[]

  // Project relations (merged from Person)
  managedProjects        Project[]           @relation("ProjectManager")
  assignedProjects       ProjectEmployee[]
  assignedTasks          Task[]              @relation("TaskAssignee")
  kanbanBoardMemberships KanbanBoardMember[]
  performedTimeRecords   TimeRecord[]        @relation("TimeRecordWorker")
  createdSeoAudits       SeoAudit[]          @relation("SeoAuditCreatedBy")

  // CRM leads
  createdLeads  Lead[] @relation("LeadCreatedBy")
  assignedLeads Lead[] @relation("LeadAssignedTo")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([companyId])
  @@index([employeeStatus])
}

// Auth.js required models
model Account {
  id                String  @id @default(cuid())
  userId            Int
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       Int
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model UserGroup {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?

  users       UserGroupUser[]
  permissions GroupPermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

model UserGroupUser {
  userId      Int
  userGroupId Int

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userGroup UserGroup @relation(fields: [userGroupId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([userId, userGroupId])
}

model Permission {
  id          Int     @id @default(autoincrement())
  module      String // e.g., "clients", "finances.income"
  action      String // e.g., "read", "create", "update", "delete"
  description String?

  groups GroupPermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([module, action])
  @@index([module, action])
}

model GroupPermission {
  userGroupId  Int
  permissionId Int

  userGroup  UserGroup  @relation(fields: [userGroupId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  grantedAt DateTime @default(now())

  @@id([userGroupId, permissionId])
}

// ============================================================================
// AUDIT LOGGING
// ============================================================================

model AuditLog {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id])

  action     String // "created", "updated", "deleted", "exported", "login", etc.
  module     String // "clients", "projects", "finances", etc.
  entityId   String? // ID of the affected record (kept as String for flexibility)
  entityType String? // "Client", "Project", "Income", etc.

  oldValues Json? // Previous state (for updates)
  newValues Json? // New state (for creates/updates)

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([module, entityId])
  @@index([createdAt])
}

// ============================================================================
// COMPANY
// ============================================================================

model Company {
  id        Int     @id @default(autoincrement())
  name      String
  legalName String?
  taxId     String?
  vatNumber String?

  // Address
  street     String?
  city       String?
  postalCode String?
  country    String?

  // Contact
  email   String?
  phone   String?
  website String?

  // Settings
  logo            String?
  currency        String  @default("USD")
  fiscalYearStart Int     @default(1) // Month (1-12)

  // Relations
  clients   Client[]
  projects  Project[]
  employees User[]    @relation("CompanyEmployees")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================================
// CONTACT MODEL - Client/Vendor contacts
// ============================================================================

model Contact {
  id               Int      @id @default(autoincrement())
  firstName        String
  lastName         String
  email            String?
  phone            String?
  mobile           String?
  position         String?
  avatarPath       String?
  isPrimaryContact Boolean  @default(false)

  clientId Int?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  vendorId Int?
  vendor   Vendor? @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  leads Lead[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([vendorId])
}

// ============================================================================
// CLIENTS
// ============================================================================

model Client {
  id        Int     @id @default(autoincrement())
  companyId Int
  company   Company @relation(fields: [companyId], references: [id])

  name        String
  companyName String?

  // Address
  street     String?
  city       String?
  postalCode String?
  country    String?

  // Business info
  taxId     String?
  vatNumber String?
  website   String?
  industry  String?

  // Contact
  email String?
  phone String?

  // Settings
  status       String @default("active") // "active", "inactive", "archived"
  paymentTerms Int    @default(30) // Days
  currency     String @default("USD")

  notes String?

  // Relations
  contacts Contact[]
  projects Project[]
  income   Income[]
  payments Payment[]
  offers   Offer[]
  leads    Lead[]

  createdById Int
  createdBy   User @relation("CreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([email])
  @@index([status])
}

// ============================================================================
// VENDORS
// ============================================================================

model Vendor {
  id Int @id @default(autoincrement())

  name        String
  companyName String?

  // Address
  street     String?
  city       String?
  postalCode String?
  country    String?

  // Business info
  taxId     String?
  vatNumber String?
  website   String?

  // Contact
  email String?
  phone String?

  // Settings
  status       String @default("active") // "active", "inactive"
  paymentTerms Int    @default(30) // Days
  currency     String @default("USD")

  category String? // Type of vendor (supplier, contractor, service provider, etc.)

  notes String?

  // Relations
  contacts Contact[]
  expenses Expense[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([category])
}

// ============================================================================
// PROJECTS
// ============================================================================

model Project {
  id        Int     @id @default(autoincrement())
  companyId Int
  company   Company @relation(fields: [companyId], references: [id])

  name        String
  description String?

  clientId Int
  client   Client @relation(fields: [clientId], references: [id])

  status   String @default("planning") // "planning", "active", "on_hold", "completed", "cancelled", "archived"
  priority String @default("medium") // "low", "medium", "high"

  startDate DateTime?
  endDate   DateTime?

  // Budget & Estimates (visible only for admin and accountant users)
  budgetEstimate Decimal? @db.Decimal(10, 2)
  estimatedHours Decimal? @db.Decimal(10, 2)

  // Relations
  projectManagerId Int?
  projectManager   User? @relation("ProjectManager", fields: [projectManagerId], references: [id], onDelete: SetNull)

  assignedEmployees ProjectEmployee[]
  tasks             Task[]
  kanbanBoards      KanbanBoard[]
  milestones        Milestone[]
  income            Income[]
  expenses          Expense[]

  createdById Int
  createdBy   User @relation("CreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([clientId])
  @@index([status])
}

model ProjectEmployee {
  projectId Int
  userId    Int

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  role       String? // Role in this project
  assignedAt DateTime @default(now())

  @@id([projectId, userId])
}

model Task {
  id Int @id @default(autoincrement())

  name        String
  description String? @db.Text // Markdown format

  type     String? // Managed via enums: "bug", "feature", "task", "improvement", etc.
  category String? // Managed via enums
  status     String  @default("todo") // "backlog", "todo", "in_progress", "review", "done"
  priority   String  @default("medium") // "low", "medium", "high", "urgent"
  isComplete Boolean @default(false)

  // Project (required - every task belongs to a project)
  projectId Int
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Kanban board placement (optional - task may not be on a board yet)
  kanbanBoardId Int?
  kanbanBoard   KanbanBoard? @relation(fields: [kanbanBoardId], references: [id], onDelete: SetNull)

  columnId Int?
  column   KanbanColumn? @relation(fields: [columnId], references: [id], onDelete: SetNull)

  swimlaneId Int?
  swimlane   KanbanSwimlane? @relation(fields: [swimlaneId], references: [id], onDelete: SetNull)

  order Int @default(0) // Ordering within column/swimlane

  // People
  assignedToId Int?
  assignedTo   User? @relation("TaskAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)

  reviewerIds Int[] // User IDs
  followerIds Int[] // User IDs

  createdById Int
  createdBy   User @relation("TaskCreatedBy", fields: [createdById], references: [id])

  // Time tracking
  startDate     DateTime?
  dueDate       DateTime?
  estimatedTime Int? // Estimated duration in minutes
  spentTime     Int          @default(0) // Total minutes from timeRecords (materialized aggregate)
  timeRecords   TimeRecord[]

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([kanbanBoardId])
  @@index([status])
  @@index([isComplete])
  @@index([assignedToId])
  @@index([startDate])
  @@index([columnId])
  @@index([swimlaneId])
}

// ============================================================================
// TIME RECORDS
// ============================================================================

model TimeRecord {
  id Int @id @default(autoincrement())

  taskId Int
  task   Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  date        DateTime // Selectable date (when the work was done)
  minutes     Int // Duration in minutes (e.g. 30, 90, 120)
  description String?
  billable    Boolean  @default(true)

  type     String? // Managed via enums (e.g. "development", "design", "meeting")
  category String? // Managed via enums (e.g. "billable", "non-billable", "overtime")

  // User who did the work
  userId Int?
  user   User? @relation("TimeRecordWorker", fields: [userId], references: [id], onDelete: SetNull)

  // Creator (editable by creator, admins, and project manager)
  createdById Int
  createdBy   User @relation("TimeRecordCreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@index([createdById])
  @@index([userId])
  @@index([date])
}

// ============================================================================
// MILESTONES
// ============================================================================

model Milestone {
  id        Int     @id @default(autoincrement())
  projectId Int
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name        String
  description String?  @db.Text
  date        DateTime
  order       Int      @default(0)

  completed   Boolean   @default(false)
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
}

// ============================================================================
// KANBAN BOARDS
// ============================================================================

model KanbanBoard {
  id        Int     @id @default(autoincrement())
  projectId Int
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name        String
  description String?

  // Relations
  members     KanbanBoardMember[]
  columns     KanbanColumn[]
  swimlanes   KanbanSwimlane[]
  tasks       Task[]
  preferences UserBoardPreference[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
}

model KanbanBoardMember {
  kanbanBoardId Int
  userId        Int

  kanbanBoard KanbanBoard @relation(fields: [kanbanBoardId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  role       String   @default("member") // "member", "viewer"
  assignedAt DateTime @default(now())

  @@id([kanbanBoardId, userId])
}

model KanbanColumn {
  id            Int         @id @default(autoincrement())
  kanbanBoardId Int
  kanbanBoard   KanbanBoard @relation(fields: [kanbanBoardId], references: [id], onDelete: Cascade)

  name             String
  order            Int     @default(0)
  color            String? // Hex color for visual distinction
  isCompleteColumn Boolean @default(false)

  tasks Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([kanbanBoardId])
}

model KanbanSwimlane {
  id            Int         @id @default(autoincrement())
  kanbanBoardId Int
  kanbanBoard   KanbanBoard @relation(fields: [kanbanBoardId], references: [id], onDelete: Cascade)

  name  String
  order Int     @default(0)
  color String? // Hex color for visual distinction

  tasks Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([kanbanBoardId])
}

model UserBoardPreference {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  kanbanBoardId Int
  kanbanBoard   KanbanBoard @relation(fields: [kanbanBoardId], references: [id], onDelete: Cascade)

  collapsedColumns   Json? // Array of column IDs: [1, 3, 5]
  collapsedSwimlanes Json? // Array of swimlane IDs: [2, 4]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, kanbanBoardId])
}

// ============================================================================
// NOTES (polymorphic - attachable to any entity)
// ============================================================================

model Note {
  id Int @id @default(autoincrement())

  // Polymorphic relation
  entityType String // "Client", "Project", "Task", "Vendor", "Income", "Expense", etc.
  entityId   String // ID of the parent entity (String for flexibility)

  content String @db.Text // Markdown format

  authorId Int?
  author   User? @relation(fields: [authorId], references: [id], onDelete: SetNull)

  priority String  @default("normal") // "low", "normal", "high", "urgent"
  color    String? // Hex color for visual categorization

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([entityType, entityId])
  @@index([authorId])
}

// ============================================================================
// TAGS (polymorphic - attachable to any entity, backed by EnumValue)
// ============================================================================

model EntityTag {
  id Int @id @default(autoincrement())

  // Polymorphic relation
  entityType String // "Client", "Project", "Task", "Vendor", etc.
  entityId   String // ID of the parent entity

  // Tag definition from EnumValue (e.g., enum type "project_tags", "client_tags")
  enumValueId Int
  enumValue   EnumValue @relation(fields: [enumValueId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([entityType, entityId, enumValueId])
  @@index([entityType, entityId])
  @@index([enumValueId])
}

// ============================================================================
// FINANCES
// ============================================================================

model Income {
  id Int @id @default(autoincrement())

  amount      Decimal  @db.Decimal(10, 2)
  tax         Decimal  @default(0) @db.Decimal(10, 2)
  tax_value   Decimal  @default(0) @db.Decimal(10, 2)
  currency    String   @default("USD")
  date        DateTime
  description String

  category String // "project_payment", "consulting", "product_sale", "other"

  // Status and payment tracking
  status  String    @default("pending") // "paid", "pending", "late", "suspended"
  dueDate         DateTime? // Payment deadline (auto-calculated from date + paymentTermDays)
  paymentTermDays Int?      // Payment term in days (e.g. 7, 14, 30)

  // Recurring settings
  isRecurring      Boolean   @default(false)
  recurringPeriod  String? // "weekly", "monthly", "quarterly", "yearly" - only when isRecurring is true
  recurringEndDate DateTime? // "Generate projections until" date
  parentId         Int?      // Self-reference: links generated occurrences to the parent
  parent           Income?   @relation("IncomeRecurring", fields: [parentId], references: [id], onDelete: Cascade)
  children         Income[]  @relation("IncomeRecurring")

  // Relations
  clientId   Int?
  clientName String? // Denormalized: preserved when client is deleted
  client     Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  projectId Int?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  paymentId Int?     @unique
  payment   Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  invoiceReference String? // External invoice number/reference
  taxRate          Decimal? @db.Decimal(5, 2)

  notes String?

  createdById Int
  createdBy   User @relation("CreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@index([clientId])
  @@index([projectId])
  @@index([category])
  @@index([status])
  @@index([dueDate])
  @@index([parentId])
}

model Expense {
  id Int @id @default(autoincrement())

  amount      Decimal  @db.Decimal(10, 2)
  tax         Decimal  @default(0) @db.Decimal(10, 2)
  tax_value   Decimal  @default(0) @db.Decimal(10, 2)
  currency    String   @default("USD")
  date        DateTime
  description String

  category String // "salary", "software", "office", "marketing", "travel", "equipment", "contractor", "other"

  // Status and payment tracking
  status  String    @default("pending") // "paid", "pending", "late", "suspended"
  dueDate         DateTime? // Payment deadline (auto-calculated from date + paymentTermDays)
  paymentTermDays Int?      // Payment term in days (e.g. 7, 14, 30)

  // Recurring settings
  isRecurring      Boolean   @default(false)
  recurringPeriod  String? // "weekly", "monthly", "quarterly", "yearly" - only when isRecurring is true
  recurringEndDate DateTime? // "Generate projections until" date
  parentId         Int?      // Self-reference: links generated occurrences to the parent
  parent           Expense?  @relation("ExpenseRecurring", fields: [parentId], references: [id], onDelete: Cascade)
  children         Expense[] @relation("ExpenseRecurring")

  // Relations
  projectId Int?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  vendorId   Int?
  vendorName String? // Denormalized: preserved when vendor is deleted
  vendor     Vendor? @relation(fields: [vendorId], references: [id], onDelete: SetNull)

  paymentId Int?     @unique
  payment   Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  receiptPath String? // File path on own server

  notes String?

  createdById Int
  createdBy   User @relation("CreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@index([projectId])
  @@index([vendorId])
  @@index([category])
  @@index([status])
  @@index([dueDate])
  @@index([parentId])
}

model Payment {
  id Int @id @default(autoincrement())

  amount   Decimal  @db.Decimal(10, 2)
  currency String   @default("USD")
  date     DateTime

  type   String // "received", "paid"
  method String // "bank_transfer", "cash", "credit_card", "check", "other"
  status String // "pending", "completed", "failed", "cancelled"

  // Relations
  clientId Int?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  income  Income?
  expense Expense?

  referenceNumber String? // Bank transaction ID, check number, etc.
  expectedDate    DateTime? // For pending payments

  reconciled     Boolean   @default(false)
  reconciledDate DateTime?

  notes String?

  createdById Int
  createdBy   User @relation("CreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@index([type])
  @@index([status])
  @@index([clientId])
}

// ============================================================================
// PRICE LISTS
// ============================================================================

model PriceListItem {
  id Int @id @default(autoincrement())

  name        String
  description String?
  sku         String? @unique
  category    String?

  unitPrice     Decimal @db.Decimal(10, 2)
  currency      String  @default("USD")
  unitOfMeasure String  @default("piece")

  taxRate Decimal? @db.Decimal(5, 2)

  active    Boolean   @default(true)
  validFrom DateTime?
  validTo   DateTime?

  // Relations
  offerItems OfferItem[]

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active])
  @@index([category])
}

// ============================================================================
// OFFERS
// ============================================================================

model Offer {
  id          Int    @id @default(autoincrement())
  offerNumber String @unique // Auto-generated
  title       String?
  showGrandTotal Boolean @default(true)

  date       DateTime @default(now())
  validUntil DateTime

  // Client (nullable â€” snapshot preserved if client deleted)
  clientId          Int?
  client            Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  clientName        String?
  clientEmail       String?
  clientCompanyName String?
  clientAddress     String?  @db.Text

  status String @default("draft") // "draft", "sent", "accepted", "rejected", "expired"

  // Financials
  currency      String   @default("USD")
  subtotal      Decimal  @db.Decimal(10, 2)
  taxTotal      Decimal  @db.Decimal(10, 2)
  grandTotal    Decimal  @db.Decimal(10, 2)
  discountType  String?  // "percentage" | "fixed"
  discountValue Decimal? @db.Decimal(10, 2)

  // Relations
  options OfferOption[]

  // Content
  terms String? @db.Text // Terms and conditions
  notes String? // Internal notes

  // PDF
  pdfUrl String?

  // Status tracking
  sentDate     DateTime?
  acceptedDate DateTime?
  rejectedDate DateTime?

  // Conversion
  convertedToProjectId Int?

  createdById Int
  createdBy   User @relation("CreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([offerNumber])
  @@index([clientId])
  @@index([status])
}

model OfferOption {
  id      Int   @id @default(autoincrement())
  offerId Int
  offer   Offer @relation(fields: [offerId], references: [id], onDelete: Cascade)

  name        String
  description String?
  order       Int

  items OfferItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([offerId])
}

model OfferItem {
  id       Int         @id @default(autoincrement())
  optionId Int
  option   OfferOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  // Can link to price list or be custom
  priceListItemId Int?
  priceListItem   PriceListItem? @relation(fields: [priceListItemId], references: [id], onDelete: SetNull)

  name          String
  description   String?
  sku           String?
  unitOfMeasure String  @default("piece")
  quantity      Decimal @db.Decimal(10, 2)
  unitPrice     Decimal @db.Decimal(10, 2)
  discount      Decimal @db.Decimal(5, 2) @default(0) // Per-item percentage discount
  taxRate       Decimal @db.Decimal(5, 2)

  // Calculated fields
  subtotal       Decimal @db.Decimal(10, 2) // quantity * unitPrice
  discountAmount Decimal @db.Decimal(10, 2) @default(0) // subtotal * (discount / 100)
  taxAmount      Decimal @db.Decimal(10, 2) // (subtotal - discountAmount) * (taxRate / 100)
  total          Decimal @db.Decimal(10, 2) // (subtotal - discountAmount) + taxAmount

  order Int // Display order

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([optionId])
}

// ============================================================================
// ENUM MANAGEMENT
// ============================================================================

model EnumType {
  id          Int     @id @default(autoincrement())
  code        String  @unique // e.g., "currency", "income_category"
  name        String // e.g., "Currencies", "Income Categories"
  description String?
  group       String  @default("Generic") // e.g., "Generic", "Finances", "Employees", "Projects"
  isSystem    Boolean @default(false) // System enums can't be deleted

  values EnumValue[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([group])
}

model EnumValue {
  id         Int      @id @default(autoincrement())
  enumTypeId Int
  enumType   EnumType @relation(fields: [enumTypeId], references: [id], onDelete: Cascade)

  value       String // Stored value: "USD", "project_payment"
  label       String // Display label: "US Dollar", "Project Payment"
  description String?

  sortOrder Int     @default(0)
  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  color    String? // Hex color (used for tags, categories, etc.)
  metadata Json? // Extensible: { "symbol": "$" } for currencies

  // Relations
  entityTags EntityTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([enumTypeId, value])
  @@index([enumTypeId, isActive])
}

// ============================================================================
// CRM LEADS
// ============================================================================

model Lead {
  id Int @id @default(autoincrement())

  title       String
  description String? @db.Text // Markdown format
  source      String? // Managed via enums (lead_source)

  stage String @default("lead") // "lead", "offer", "approval", "won", "lost", "postponed", "archived"
  order Int    @default(0)      // Ordering within stage column

  // Relations
  clientId    Int?
  clientName  String? // Denormalized: preserved when client is deleted
  client      Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  contactId   Int?
  contactName String? // Denormalized: preserved when contact is deleted
  contact     Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  assignedToId Int?
  assignedTo   User? @relation("LeadAssignedTo", fields: [assignedToId], references: [id], onDelete: SetNull)

  createdById Int
  createdBy   User @relation("LeadCreatedBy", fields: [createdById], references: [id])

  // Financial
  budget   Decimal? @db.Decimal(10, 2)
  currency String?  @default("HUF")

  // Time
  estimatedHours Int?      // Estimated duration in minutes
  offerDueDate   DateTime?
  deadline       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([stage])
  @@index([clientId])
  @@index([assignedToId])
  @@index([createdById])
}

// ============================================================================
// TOOLS
// ============================================================================

model SeoAudit {
  id        Int    @id @default(autoincrement())
  status    String @default("pending") // pending | running | completed | failed
  language  String @default("en")      // Language code for AI output (en, hu, de, etc.)
  urls      Json                       // String[] input URLs
  progress  Json?                      // { currentUrl, currentStep, completedUrls, totalUrls }
  results   Json?                      // Per-URL findings array
  summary   Json?                      // Overall scores + AI recommendations
  pdfPath   String?                    // Relative path to generated PDF
  error     String? @db.Text           // Failure message

  createdById Int
  createdBy   User @relation("SeoAuditCreatedBy", fields: [createdById], references: [id])

  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([createdById])
  @@index([status])
  @@index([createdAt])
}
